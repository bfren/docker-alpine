#!/usr/bin/env sh

set -euo pipefail


#======================================================================================================================
# Move Nushell config
#======================================================================================================================

NU=/etc/nu
CFG=/root/.config/nushell
mv ${CFG}/config.nu ${NU}
mv ${CFG}/env.nu ${NU}


#======================================================================================================================
# Create user links to Nushell config
#======================================================================================================================

ln -sf ${NU}/config.nu ${CFG}/config.nu
ln -sf ${NU}/env.nu ${CFG}/env.nu
ln -sf ${NU}/scripts ${CFG}/scripts


#======================================================================================================================
# Delete Nushell plugins
#======================================================================================================================

rm -rf ${CFG}/plugins
rm -rf /usr/bin/nu_plugin_*


#======================================================================================================================
# Set permissions
#======================================================================================================================

echo "Setting bf-install permissions."
chmod 0500 /usr/bin/bf/bf-install


#======================================================================================================================
# Test Nushell version
#======================================================================================================================

echo "Testing Nushell version."
INSTALLED_VERSION=$(nu -v)
if [ "${INSTALLED_VERSION}" == "${NU_VERSION}" ] ; then
    echo "Nushell ${INSTALLED_VERSION} detected."
else
    echo "Detected Nushell version '${INSTALLED_VERSION}' - expecting '${NU_VERSION}'."
    exit 1
fi
