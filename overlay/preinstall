#!/usr/bin/env sh

set -euo pipefail


#======================================================================================================================
# Create user links to Nushell config
#======================================================================================================================

NU=/etc/nu
CFG=/root/.config/nushell
mkdir -p ${CFG}
ln -sf ${NU}/config.nu ${CFG}/config.nu
ln -sf ${NU}/env.nu ${CFG}/env.nu
ln -sf ${NU}/scripts ${CFG}/scripts


#======================================================================================================================
# Delete Nushell plugins
#======================================================================================================================

rm -rf ${NU}/plugins


#======================================================================================================================
# Set permissions
#======================================================================================================================

echo "Setting bf-install permissions."
chmod 0500 /usr/bin/bf/bf-install


#======================================================================================================================
# Test Nushell version
#======================================================================================================================

echo "Testing Nushell version."
INSTALLED_VERSION=$(nu -v)
if [ "${INSTALLED_VERSION}" == "${NU_VERSION}" ] ; then
    echo "Nushell ${INSTALLED_VERSION} detected."
else
    echo "Detected Nushell version '${INSTALLED_VERSION}' - expecting '${NU_VERSION}'."
    exit 1
fi
