#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Set permissions.
#======================================================================================================================

chmod +x /init

bf-ch -o root:root -m 1777 /etc/bf/src
bf-ch -o root:root -r /etc/bf/templates && \
    bf-ch -m 0444 -t f /etc/bf/templates && \
    bf-ch -m 0555 -t d /etc/bf/templates
bf-ch -o root:root -m 1777 /tmp
bf-ch -o root:root -m 0555 -t f /usr/lib/bf


#======================================================================================================================
# Make sure apk is working correctly (fixes some strange 'no such file or directory errors' on apk FETCH).
#======================================================================================================================

apk fix
apk verify


#======================================================================================================================
# Run install script in /tmp.
#======================================================================================================================

INSTALL=/tmp/install
[[ ! -f ${INSTALL} ]] && bf-error "${INSTALL} does not exist."

chmod +x ${INSTALL} && ${INSTALL}
bf-done


#======================================================================================================================
# Store Alpine version.
#======================================================================================================================

echo "${ALPINE_REVISION}" > /BF_ALPINE


#======================================================================================================================
# Store image version.
#======================================================================================================================

echo "${BF_IMAGE/docker-/}" > /BF_IMAGE
echo "${BF_VERSION}" > /BF_VERSION
bf-image


#======================================================================================================================
# Perform cleanup.
#======================================================================================================================

bf-clear
