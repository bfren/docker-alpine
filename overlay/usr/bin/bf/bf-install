#!/usr/bin/env nu

use ../../lib/bf/
bf env set_executable

def main [] {
    # set permissions
    bf ch -o root:root -m 0555 -r /init $env.BF_BIN $env.BF_LIB
    bf ch -o root:root -m 1777 /etc/bf/src /tmp
    bf ch -o root:root -r /etc/bf/templates
    bf ch -m 0444 -t f /etc/bf/templates
    bf ch -m 0555 -t d /etc/bf/templates

    # make sure apk is working correctly (fixes some strange 'no such file or directory errors' on apk FETCH)
    apk fix
    apk verify

    # run install script in /tmp
    let install = "/tmp/install"
    if ($install | path type) != "file" {
        bf print notok_error $"($install) does not exist."
    }

    chmod +x $install; $install
    bf print ok_done

    # store versions
    $env.ALPINE_REVISION | save /BF_ALPINE
    $env.BF_IMAGE | str replace "docker-" "" | save /BF_IMAGE
    $env.BF_VERSION | save /BF_VERSION
    bf-image

    # cleanup installation files / caches etc
    bf-clear
}
