#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Store image version.
#======================================================================================================================

echo "${BF_IMAGE/docker-/}" > BF_IMAGE
echo "${BF_VERSION}" > /BF_VERSION
bf-image


#======================================================================================================================
# Set permissions.
#======================================================================================================================

bf-ch -o root:root -m 1777 /etc/bf/src
bf-ch -o root:root -r /etc/bf/templates && \
    bf-ch -m 0444 -t f /etc/bf/templates && \
    bf-ch -m 0555 -t d /etc/bf/templates
bf-ch -o root:root -m 1777 /tmp
bf-ch -o root:root -m 0500 -t f ${BF_BIN}
bf-ch -o root:root -m 0555 -t f /usr/lib/bf


#======================================================================================================================
# Run install script in /tmp and then perform cleanup.
#======================================================================================================================

INSTALL=/tmp/install
[[ ! -f ${INSTALL} ]] && bf-error "${INSTALL} does not exist."

chmod +x ${INSTALL} && ${INSTALL}
bf-done


#======================================================================================================================
# Perform cleanup.
#======================================================================================================================

bf-clear
rm ${BF_BIN}/bf-install
